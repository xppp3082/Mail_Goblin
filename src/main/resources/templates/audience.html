<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Audience</title>
    <!-- Bootstrap CSS -->
    <link href="/_css/navbar.css" rel="stylesheet">
    <link href="/_css/highchart.css" rel="stylesheet">
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div th:insert="_components/navbar.html"></div>
<div class="container mt-5">
    <h1>Audience</h1>
    <hr>
</div>
<br><br>
<div class="container">
    <h1>Add User</h1>
    <br><br>
    <!-- Add User Form -->
    <form id="addUserForm">
        <div class="form-group">
            <label for="name">Name:</label>
            <input class="form-control" id="name" name="name" placeholder="Enter name" type="text">
        </div>
        <div class="form-group">
            <label for="email">Email:</label>
            <input class="form-control" id="email" name="email" placeholder="Enter email" type="email">
        </div>
        <div class="form-group">
            <label for="birthday">Birthday:</label>
            <input class="form-control" id="birthday" name="birthday" type="date">
        </div>
        <!--        <div class="form-group">-->
        <!--            <label for="tags">Tags:</label>-->
        <!--            <select multiple class="form-control" id="tags" name="tags">-->
        <!--                &lt;!&ndash; Tags options will be populated here &ndash;&gt;-->
        <!--            </select>-->
        <!--        </div>-->
        <div class="form-group" id="tagOptions">
            <!-- Tags options will be populated here -->
        </div>
        <button class="btn btn-primary" type="submit">Add User</button>
    </form>
</div>
<br><br>
<div class="container">
    <h2>User List</h2>
    <!-- User Table -->
    <table class="table">
        <thead>
        <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Birthday</th>
            <th>Mail Count</th>
            <th>Open Count</th>
            <th>Click Count</th>
            <th>Tags</th>
            <th>Action</th>
        </tr>
        </thead>
        <tbody id="userList">
        <!-- 使用者資料將動態插入到這裡 -->
        </tbody>
    </table>
</div>
<div class="d-flex justify-content-center mt-4" id="audience-pagination">
    <button id="prevAudienceButton" onclick="previousAudiencePage()"> <<</button>
    <span id="audience-currentPage">1</span>
    <button id="nextAudienceButton" onclick="nextAudiencePage()"> >></button>
</div>
<div class="container" id="new-add"></div>
<figure class="container">
    <div id="new-audience-container"></div>
</figure>
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script charset="utf-8" src="https://cdn.plot.ly/plotly-latest.min.js"></script>

<!--high chart import test-->
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/series-label.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<script src="https://code.highcharts.com/modules/export-data.js"></script>
<script src="https://code.highcharts.com/modules/accessibility.js"></script>
<script>
    localStorage.setItem('token', 'eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJ0ZXN0MTIzNDVAZXhhbXBsZS5jb20iLCJpYXQiOjE3MTM3NjIxNjEsImV4cCI6MTcxNzM2MjE2MSwiY29tcGFueSI6eyJpZCI6MTEsInRpdGxlIjoi6Zi_5a-s5YWs5Y-4IiwiZGVzY3JpcHRpb24iOiLkuIDplpPmlrDlibXlhazlj7giLCJpbmR1c3RyeSI6InNvZnR3YXJlIGRldmVsb3BtZW50IiwiYW5uaXZlcnNhcnkiOjE1ODcwNTI4MDAwMDAsImFjY291bnQiOiJ0ZXN0MTIzNDVAZXhhbXBsZS5jb20iLCJwYXNzd29yZCI6IiQyYSQxMCRhZnd2MTd4RkVLVG1VdFJ6QUVOY3V1TVN0RnJTTEJ0M1QyVW5WWktzM0VFR0J2NDl4dGVKNiIsImNvbXBhbnlfdXVpZCI6IjBhZDkwZWRkLTYyOGYtNGQwNi1iMzI4LTNhYzFkYjg1MTA2NyJ9LCJ0aXRsZSI6IumYv-WvrOWFrOWPuCIsImFjY291bnQiOiJ0ZXN0MTIzNDVAZXhhbXBsZS5jb20ifQ.7ywY3ZbEZdLhRHNXsFcC3aaEUbP6G-nm2_AmIp5-oq4');
    const token = localStorage.getItem('token');
    const headers = {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
    };
    window.onload = async function () {
        await loadTags();
        await loadUsersWithPage(0);
    }

    async function loadTags() {
        try {
            const response = await fetch('/api/1.0/tag/get', {
                method: 'GET',
                headers: headers
            });
            const tags = await response.json();
            // displayTags(tags);
            populateTagOptions(tags);
        } catch (error) {
            console.error(error);
        }
    }


    async function loadUsers() {
        try {
            const response = await fetch('/api/1.0/audience/all', {
                method: 'GET',
                headers: headers
            });
            const users = await response.json();
            displayUsers(users);
        } catch (error) {
            console.error(error);
            alert('Failed to load users');
        }
    }

    async function loadUsersWithPage(paging) {
        try {
            const response = await fetch(`api/1.0/audience/paging?number=${paging}`, {
                method: 'GET',
                headers: headers
            });
            const audienceData = await response.json();
            const audiences = audienceData.data;
            const nextPage = audienceData.next_paging;
            console.log(audiences);
            displayUsers(audiences);

            const prevButton = document.getElementById('prevAudienceButton');
            const nextButton = document.getElementById('nextAudienceButton');
            if (paging <= 0) {
                prevButton.disabled = true;
            } else {
                prevButton.disabled = false;
            }
            if (typeof nextPage === 'undefined') {
                nextButton.disabled = true;
            } else {
                nextButton.disabled = false;
            }

        } catch (error) {
            console.log(error);
        }
    }

    let currentAudiencePage = 0;

    function nextAudiencePage() {
        currentAudiencePage++;
        document.getElementById('audience-currentPage').innerText = currentAudiencePage + 1;
        loadUsersWithPage(currentAudiencePage);
    }

    function previousAudiencePage() {
        if (currentAudiencePage >= 1) {
            currentAudiencePage--;
            document.getElementById('audience-currentPage').innerText = currentAudiencePage + 1;
            loadUsersWithPage(currentAudiencePage);
        }
    }

    // 顯示使用者列表
    function displayUsers(users) {
        const userList = document.getElementById('userList');
        userList.innerHTML = ''; // 清空現有列表

        users.forEach(function (user) {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${user.name}</td>
                <td>${user.email}</td>
                <td>${user.birthday}</td>
                <td>${user.mailcount}</td>
                <td>${user.opencount}</td>
                <td>${user.clickcount}</td>
                <td>${getTagsAsString(user.tags)}</td>
                <td><button class="btn btn-danger btn-sm" onclick="deleteUser(${user.id})">Delete</button></td>
            `;
            userList.appendChild(row);
        });
    }

    // 將標籤轉換為字串
    function getTagsAsString(tags) {
        if (!tags || tags.length === 0) {
            return 'No tags';
        }
        return tags.map(tag => tag.name).join(', ');
    }

    // 刪除使用者
    async function deleteUser(userId) {
        try {
            const response = await fetch(`/api/1.0/audience/delete?id=${userId}`, {
                method: 'DELETE',
                headers: headers
            });
            if (response.ok) {
                alert('User deleted successfully');
                // await loadUsers(); // 重新載入使用者列表
                await loadUsersWithPage(currentAudiencePage);
            } else {
                throw new Error('Failed to delete user');
            }
        } catch (error) {
            console.error(error);
            alert('Failed to delete user');
        }
    }

    // 填充標籤選項
    function populateTagOptions(tags) {
        // const tagSelect = document.getElementById('tags');
        // tagSelect.innerHTML = ''; // 清空選項

        // tags.forEach(function(tag) {
        //     const option = document.createElement('option');
        //     option.value = tag.id;
        //     option.innerText = tag.name;
        //     tagSelect.appendChild(option);
        // });
        const tagOptionsDiv = document.getElementById('tagOptions');
        tagOptionsDiv.innerHTML = ''; // 清空選項

        tags.forEach(function (tag) {
            const checkboxDiv = document.createElement('div');
            checkboxDiv.classList.add('form-check');

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.classList.add('form-check-input');
            checkbox.value = tag.id;
            checkbox.name = 'tags';
            checkbox.id = 'tag' + tag.id;

            const label = document.createElement('label');
            label.classList.add('form-check-label');
            label.htmlFor = 'tag' + tag.id;
            label.innerText = tag.name;

            checkboxDiv.appendChild(checkbox);
            checkboxDiv.appendChild(label);

            tagOptionsDiv.appendChild(checkboxDiv);
        });
    }

    document.getElementById('addUserForm').addEventListener('submit', async function (event) {
        event.preventDefault(); // 阻止表單默認提交行為

        // 手動構建包含 name、email 和 birthday 的對象
        const user = {
            name: document.getElementById('name').value,
            email: document.getElementById('email').value,
            birthday: document.getElementById('birthday').value,
            tags: [] // 初始化 tags 數組
        };

        // 遍歷選中的標籤，將其添加到 tags 數組中
        document.querySelectorAll('input[name="tags"]:checked').forEach(function (checkbox) {
            user.tags.push({
                id: parseInt(checkbox.value), // 將值轉換為整數
                company_id: 11, // 假設 company_id 固定為 1，你可以根據實際情況調整
                name: checkbox.dataset.name // 如果需要，你可以從 checkbox 的 data 屬性中獲取標籤名稱
            });
        });

        // 將 user 對象轉換為 JSON 字符串並添加到 FormData 中
        const formData = new FormData();
        formData.append('user', JSON.stringify(user));

        console.log(formData.toString()); // 輸出 FormData 字符串表示形式
        console.log([...formData]); // 輸出 FormData 中的鍵值對

        // 提交 FormData
        try {
            const response = await fetch('/api/1.0/audience/add', {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(user)
                // body: JSON.stringify(requestData)
            });
            if (response.ok) {
                alert('User added successfully');
                // 清空表單
                this.reset();
                await loadTags(); // 重新載入標籤列表
                await loadUsersWithPage(currentAudiencePage);
            } else {
                throw new Error('Failed to add user');
            }
        } catch (error) {
            console.error(error);
            alert('Failed to add user');
        }
    });

    async function fetchNewAudienceData(days) {
        try {
            const response = await fetch('/api/1.0/audience/new-count?days=' + days, {
                method: 'GET',
                headers: headers
            });
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return await response.json();
        } catch (error) {
            throw new Error('There was a problem with the fetch operation:', error);
        }
    }

    function drawNewAudienceChart(data, elementID) {
        const categories = Object.keys(data).reverse();
        const newAudienceData = Object.values(data).reverse();
        Highcharts.chart(elementID, {
            chart: {
                type: 'column'
            },
            title: {
                text: 'New Audience Count in the Last 7 Days',
                align: 'left'
            },
            subtitle: {
                text: 'Source: Your API Endpoint',
                align: 'left'
            },
            xAxis: {
                categories: categories,
                accessibility: {
                    description: 'Dates'
                }
            },
            yAxis: {
                title: {
                    text: 'Count'
                }
            },
            tooltip: {
                valueSuffix: ''
            },
            series: [{
                name: 'New Audience',
                data: newAudienceData
            }]
        });
    }

    async function fetchAndDrawNewAudienceChart() {
        try {
            const data = await fetchNewAudienceData(7);
            drawNewAudienceChart(data, 'new-audience-container');
        } catch (error) {
            console.error(error);
        }
    }

    fetchAndDrawNewAudienceChart();
</script>
</body>
</html>